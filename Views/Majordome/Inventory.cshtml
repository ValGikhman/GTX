@using Newtonsoft.Json
@model GTX.Models.BaseModel
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script src="~/Scripts/just-validate/just-validate.production.min.js"></script>
    <script src="~/Scripts/majordome.js"></script>

    <style>
        #dataOneContainer {
            overflow-y: auto;
            height: 37rem;
        }

        .filterLiked, .filterLast, .filterLiked, .filterHelp, .sort {
            display: none !important;
        }

        #filterWrapper {
            width: 72% !important;
        }

        .body-content {
            height: 100%;
            margin-top: 5rem;
        }

        .dropzone {
            --dz-label-size: clamp(26px, 2.4vw, 28px);
            transition: background-color .15s, border-color .15s;
        }

            .dropzone::after {
                content: "Drop your files here";
                position: absolute;
                inset: 0; /* top/right/bottom/left: 0 */
                display: grid; /* easy centering */
                place-items: center; /* center both axes */
                font-size: var(--dz-label-size);
                font-weight: 800;
                color: #333;
                opacity: 0;
                pointer-events: none; /* don't block drops */
                transition: opacity .15s;
            }

            .dropzone.dragover {
                background: #bbb;
                border: 3px dashed #727171;
            }

                .dropzone.dragover::after {
                    opacity: 1;
                }

        #sortable-gallery > li {
            list-style: none;
        }

        .sortable-placeholder {
            border: 2px dashed #bbb;
            background: #f8f9fa;
            height: 160px;
            border-radius: .5rem;
        }

        #specials {
            margin-top: 0px;
        }

        #filterByTerm {
            position: relative !important;
            background: none;
            padding: unset;
            box-shadow: none
        }

        #story .ql-editor {
            min-height: 480px;
            max-height: 480px;
            overflow-y: auto;
        }


            #story .ql-editor p {
                margin-top: 10px;
                margin-bottom: 10px;
                padding: 0;
                font-size: clamp(0.9rem, 2vw, 1rem);
                text-align: justify;
            }

            /*So I need to override them for Quill*/
            #story .ql-editor strong {
                margin-top: 10px;
                margin-bottom: 10px;
                padding: 0;
                font-size: clamp(0.9rem, 2vw, 1rem);
                text-align: justify;
            }

        /*Quill strips away p-story and strong-story classes*/
        .p-story {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 0;
            font-size: clamp(0.9rem, 2vw, 1rem);
            text-align: justify;
        }

        .strong-story {
            color: black;
        }
    </style>

    <!-- Includes all JS & CSS for the JavaScript Data Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>

    <!-- Lightbox2 JS -->
    <link href="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/css/lightbox.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Include stylesheet -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
    <!-- Include the Quill library -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
</head>

<div id="inventoryOverlay" class="spinner-overlay spinner-hidden">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Working...</span>
    </div>
</div>

<!-- Modal -->
<div class="modal modal-xl" id="overlayModal" data-bs-keyboard="true" tabindex="-1" aria-labelledby="overlayModal" aria-hidden="true">
    <div class=" modal-dialog modal-dialog-centered">
        <div id="vehicle-overlay" class="modal-content">
        </div>
    </div>
</div>

<div class="this-container container-fluid px-5">
    <nav class="nav nav-tabs no-wrap-group" id="myTab" role="tablist">
        <button class="btn btn-gradient-grey text-shadow-small active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#tab-inventory" type="button" role="tab">
            Inventory
        </button>
        <button class="btn btn-gradient-grey text-shadow-small" id="details-tab" data-bs-toggle="tab" data-bs-target="#tab-details" type="button" role="tab">
            Details
        </button>
        @if (!@Model.IsEZ360)
        {
            <button class="btn btn-gradient-grey text-shadow-small" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#tab-gallery" type="button" role="tab">
                Photos
            </button>
        }

        @if (@Model.IsDataOne)
        {
            <button class="btn btn-gradient-grey text-shadow-small" id="vin-decoder-tab" data-bs-toggle="tab" data-bs-target="#tab-vin-decoder" type="button" role="tab">
                Vin decoder
            </button>
        }
        <button class="btn btn-gradient-grey text-shadow-small d-none" id="QR-code-tab" data-bs-toggle="tab" data-bs-target="#tab-qr-code" type="button" role="tab">
            QR Code
        </button>
        <button class="btn btn-gradient-grey text-shadow-small" id="EZ360-tab" data-bs-toggle="tab" data-bs-target="#tab-ez360" type="button" role="tab">
            EZ360 Vehicle info
        </button>
        <div id="specials" class="d-none d-lg-block d-flex ms-auto"></div>
    </nav>

    <div class="tab-content border border-top-0 well " id="myTabContent">
        <!-- Inventory Tab -->
        <div class="tab-pane fade show active py-2" id="tab-inventory" role="tabpanel">
            <div class="container-fluid">
                <div class="row align-items-center justify-content-center">
                    <div id="filtersWrap" class="col-auto w-35">
                        @{ Html.RenderPartial("_FilterByTerm"); }
                    </div>
                </div>
                <!-- Grid shell gets a dynamic height -->
                <div id="gridShell" class="mx-auto row row-cols-3">
                    <div id="myGrid" class="ag-theme-alpine"></div>
                </div>
            </div>
        </div>

        <!-- Details Tab -->
        <div class="tab-pane fade" id="tab-details" role="tabpanel">
            <div class="row">
                <!-- Left Column: Form -->
                <div class="col-lg-7">
                    <div id="dataOneDetails" class="row mt-3 d-flex justify-content-center">
                    </div>
                </div>
                <div class="col-lg-5 text-shadow-small">
                    <div class="row">
                        @Html.Label("Title", new { @class = "text-shadow" })
                        <div class="input-group mb-3">
                            <input id="title" class="form-control shadow pull-right" placeholder="Title" aria-label="Title" aria-describedby="title" />
                            <button id="createStory" class="btn btn-light bi bi-book input-group-text "></button>
                            <button id="deleteStory" class="btn btn-light bi bi-book-fill input-group-text"></button>
                            <button id="saveStory" class="btn btn-light bi bi-save input-group-text"></button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        @Html.Label("Story", new { @class = "text-shadow" })
                        <div id="story" class="form-control shadow"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Tab -->
        @if (!@Model.IsEZ360)
        {
            <div class="tab-pane fade d-flex flex-column align-items-center" id="tab-gallery" role="tabpanel">
                <div class="d-flex justify-content-center w-100 p-3">
                    <button id="upload" class="btn btn-light shadow mx-2 bi bi-upload">&nbsp;Upload stock images</button>
                    <button id="deleteAll" class="btn btn-light shadow bi bi-trash">&nbsp;Delete stock all images</button>
                    <input type="file" id="fileInput" class="d-none" multiple accept="image/*">
                </div>
                <div id="dropzone" class="dropzone w-100">
                    <div id="gallery-content" class="flex-grow-1 w-100 px-3 pb-3">
                        <ul id="sortable-gallery" class="row justify-content-center">
                        </ul>
                    </div>
                </div>
            </div>
        }

        <!-- Vin decoder Tab -->
        @if (@Model.IsDataOne)
        {
            <div class="tab-pane fade" id="tab-vin-decoder" role="tabpanel">
                <div class="row">
                    <!-- Left Column: Form -->
                    <div class="row col-lg-6 mt-3">
                        @Html.Label("VIN", new { @class = "text-shadow" })
                        <div class="input-group mb-2">
                            <input id="vin" class="form-control shadow" placeholder="VIN" aria-label="VIN" aria-describedby="vin" />
                            <button id="decode" class="btn btn-light bi bi-search input-group-text "></button>
                        </div>
                    </div>
                    <div id="dataOneVinDecoder" class="row mt-3 d-flex justify-content-center">
                    </div>
                </div>
            </div>
        }

        <!-- QR Code Tab -->
        <div class="tab-pane fade" id="tab-qr-code" role="tabpanel">
            <div class="row">
                <div class="col-3 d-flex flex-column align-items-center text-center">
                    <div id="qrPrintArea" class="m-3" style="width:400px;">
                        <h3>ATTENTION</h3>
                        <h3>Car shoppers!</h3>
                        <div>Scan the code  with your mobile phone's camera app for more information about this vehicle</div>
                        <img id="qrImg" src="" alt="QR Code" style="width:300px;height:300px;" />
                        <div id="qrText" class="very-small-text"></div>
                    </div>
                    <div class="m-3">
                        <button type="button" class="btn btn-gradient shadow" onclick="printQrArea()">Print QR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EZ360 info -->
        <div class="tab-pane fade" id="tab-ez360" role="tabpanel">
        </div>
    </div>
</div>
<template id="actions">
    <button type="button" id="btnDecodeAll" class="btn btn-gradient shadow">Decode all</button>
    <button type="button" id="btnReStoryAll" class="btn btn-gradient shadow">Re-story all</button>
    <button type="button" id="btnUploadInventory" class="btn btn-gradient shadow">Upload inventory</button>
    <button type="button" id="btnRestoreBackUpInventory" class="btn btn-gradient shadow">Restore back up</button>
    <input type="file" name="dataCsv" id="dataCsv" class="d-none" accept=".csv,text/csv" />
</template>

<input type="hidden" id="currentVehicle" />

<script type="text/javascript">
    const $dropzone = $("#dropzone");
    let gridApi, gridColumnApi = null;

    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
        //['blockquote', 'code-block'],
        ['link', 'image', 'video'],

        //[{ 'header': 1 }, { 'header': 2 }],               // custom button values
        //[{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
        //[{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
        [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
        //[{ 'direction': 'rtl' }],                         // text direction

        [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
        [{ 'font': [] }],
        [{ 'align': [] }]

        //['clean']                                         // remove formatting button
    ];

    const quill = new Quill('#story', {
        modules: {
            toolbar: toolbarOptions
        },
        theme: 'snow'
    });

    $(function () {
        var grid = document.querySelector("#myGrid");
        agGrid.createGrid(grid, gridOptions);

        // Drag & drop events
        const prevent = e => { e.preventDefault(); e.stopPropagation(); };
            ["dragenter","dragover","dragleave","drop"].forEach(evt => {
            $dropzone.on(evt, prevent);
        });

        $dropzone.on("dragover", () => $dropzone.addClass("dragover"));
        $dropzone.on("dragleave drop", () => $dropzone.removeClass("dragover"));
        $dropzone.on("drop", (e) => {
            const dt = e.originalEvent.dataTransfer;
            if (dt && dt.files) handleFiles(dt.files);
        });

        $dropzone.on('paste', function (e) {
            const oe = e.originalEvent;
            const dt = oe.clipboardData;
            if (!dt) return;

            // Prefer actual files (screenshots, copied files)
            if (dt.files && dt.files.length) {
                e.preventDefault();
                handleFiles(dt.files);
                return;
            }

            // Fallback: items -> File
            const items = (dt.items ? Array.from(dt.items) : [])
                .filter(i => i.kind === 'file')
                .map(i => i.getAsFile())
                .filter(Boolean);

            if (items.length) {
                e.preventDefault();
                handleFiles(items);
            }
        });

        $(document).on("click", ".delete-image", function () {
            var file = $(this).data("filename");
            var id = $(this).attr("id");
            if (confirm("Do you want to delete this file?")) {
                deleteImage(id, file, this);
            }
        });

        $(document).on("click", ".overlay-image", function () {
            var id = $(this).attr("id");
            showOverlayModal(id);
        });

        $(document).on("click", ".move-to-top", function (e) {
            e.stopPropagation();

            const $this = $(this);
            const $item = $this.closest("li");

            // Move this item to the top
            $item.prependTo("#sortable-gallery");

            const sorted = getSortedIds();
            saveOrder(sorted, stock)
            updateGalleryDisplay();
        });

        $("#specials").html($("#actions").html());

        $("#btnReStoryAll").on("click", function () {
            if (confirm("Restory all vehicles")) {
                reStoryAll();
            }
        });

        $("#btnDecodeAll").on("click", function () {
            if (confirm("Decode all vehicles")) {
                decodeAll();
            }
        });

        $("#deleteAll").on("click", function () {
            const stock = selectedVehicle.Stock;
            if (confirm(`Deleting all images for Stock# ${stock}`)) {
                deleteImages(stock);
            }
        });

        $("#createStory").on("click", function () {
            const stock = selectedVehicle.Stock;
            if (confirm(`Do you want to create story for Stock# ${stock}`)) {
                createStory(stock);
            }
        });

        $("#deleteStory").on("click", function () {
            const stock = selectedVehicle.Stock;
            if (confirm(`Do you want to delete story for Stock# ${stock}`)) {
                deleteStory(stock);
            }
        });

        $("#saveStory").on("click", function () {
            const stock = selectedVehicle.Stock;
            var story = quill.root.innerHTML;
            const title = $("#title").val();

            if (confirm(`Do you want to save story for Stock# ${stock}`)) {
                showSpinner($("#inventoryOverlay"));

                fetch('/Majordome/SaveStory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock, story, title })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Server error");
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log("✅ Story saved:", data.message);
                        fetch('/Majordome/GetUpdatedItems')
                            .then(res => res.json())
                            .then(data => {
                                updateRow(data);
                        });
                    } else {
                        console.log("❌ Server returned error:", data.message);
                    }
                })
                .catch(error => {
                    console.log("❌ Error submitting:", error);
                });
            }
        });

        $("#upload").on("click", function () {
            $('#fileInput').click();
        });

        $("#fileInput").on("change", function () {
            const files = Array.from(fileInput.files);
            const stock = selectedVehicle.Stock;

            if (files.length > 0) {
                uploadFiles(stock, fileInput);
            }
        });

        $("#btnRestoreBackUpInventory").on("click", function () {
            if (confirm("Do you want to restore backup an inventory?")) {
                restoreBackUpInventory();
            }
        });

        $("#btnUploadInventory").on("click", function () {
            $("#dataCsv").click();
        });

        $("#dataCsv").on("change", function () {
            var file = this.files && this.files.length ? this.files[0].name : "";
            if (file.length > 0) {
                if (confirm("Do you want to upload a inventory?")) {
                    uploadInventory(this);
                }
            }
        });

        $("#vin").on("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const vin = $(this).val();
                if (vin.length > 0) {
                    decodeDataOneByAnyVin(vin);
                }
            }
        }).focus();

        $("#decode").on("click", function () {
            const vin = $("#vin").val();
            if (vin.length > 0) {
                decodeDataOneByAnyVin(vin);
            }
        })

        $("#EZ360-tab").on("click", function () {
            const stock = selectedVehicle.Stock;
            if (stock.length > 0) {
                showEZ360(stock);
            }
        })

        $("#myGrid").on("dblclick", ".details", function () {
            $("#details-tab").tab("show");
        });

        $("#myGrid").on("dblclick", ".grid-image", function () {
            $("#gallery-tab").tab("show");
        });
    });

    function getSortedIds() {
        return $("#sortable-gallery li").map(function () {
            return $(this).attr("id");
        }).get();
    }

    const nfUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const nfInt = new Intl.NumberFormat('en-US');

    const fmtPrice = v => (v ?? v === 0) ? nfUSD.format(v) : '';
    const fmtMileage = v => (v ?? v === 0) ? nfInt.format(v) : '';

    const columnDefs = [
    {
        field: "images",
        colId: "images",
        valueGetter: function (params) {
            return params.data.Image || "";
        },
        cellRenderer: imageButtonRenderer,
        filter: false,
        sortable: true,
        width: 200,
        cellClass: 'd-flex align-items-center justify-content-center',
        comparator: function (valueA, valueB) {
            // Convert to 1 if has image, 0 if "noimage"
            console.log(valueA, valueB)
            const hasImageA = valueA && !valueA.toLowerCase().includes("no-image") ? 1 : 0;
            const hasImageB = valueB && !valueB.toLowerCase().includes("no-image") ? 1 : 0;

            return hasImageA - hasImageB; // ascending: noimage first, then images
        },
    },
    {
        headerName: "Details",
        filter: false,
        width: 170,
        minWidth: 120,
        field: "Vehicle", // You can use any placeholder field
        colId: "Vehicle",
        autoHeight: true,
        sortable: true,
        comparator: (valueA, valueB, nodeA, nodeB) => {
            const a = `${nodeA.data.Year} ${nodeA.data.Make} ${nodeA.data.Model}`.toLowerCase();
            const b = `${nodeB.data.Year} ${nodeB.data.Make} ${nodeB.data.Model}`.toLowerCase();

            if (a < b) return -1;
            if (a > b) return 1;
            return 0;
        },
        cellRenderer: vehicleDetailsCellRenderer,
        getQuickFilterText: (params) => {
            const { Year, Make, Model, VehicleStyle, Stock, VIN } = params.data;
            return `${Year} ${Make} ${Model} ${VehicleStyle} ${Stock} ${VIN}`;
        }
    },
    {
        headerName: "Purchased",
        field: "PurchaseDate",
        colId: "PurchaseDate",
        filter: 'agDateColumnFilter',
        sortable: true,
        width: 160,
        minWidth: 120,
        comparator: (date1, date2) => {
            if (date1 == null && date2 == null) return 0;
            if (date1 == null) return -1;
            if (date2 == null) return 1;
            return date1.getTime() - date2.getTime();
        },
        valueGetter: params => params.data.PurchaseDate ? new Date(params.data.PurchaseDate) : null,
        valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString('en-US') : ''
    },
    {
        headerName: "Stock",
        field: "Stock",
        colId: "Stock",
        filter: true,
        width: 110,
        minWidth: 100
    },
    {
        headerName: "GTX",
        field: "LocationCode",
        colId: "LocationCode",
        filter: true,
        width: 150,
        minWidth: 120
    },
    {
        headerName: "Upload",
        field: "SetToUpload",
        colId: "SetToUpload",
        sortable: true,
        width: 150,
        minWidth: 100,
        cellRenderer: params => {
            return params.value === "Y" ? "✔" : "";
        }
    },
    {
        headerName: 'Story',
        field: 'Story',
        colId: 'Story',
        width: 80,
        cellRenderer: (params) => {
            const story = params.data?.Story; // optional chaining
            const hasTitle = story?.Title != null && story.Title !== "";
            return hasTitle ? "✔" : "";
        },
        filter: false,
        sortable: true,
        comparator: (a, b) => {
            // a & b are the raw Story objects
            const aHasTitle = a && a.Title ? 1 : 0;
            const bHasTitle = b && b.Title ? 1 : 0;
            return aHasTitle - bHasTitle;
        },
    },
    {
        headerName: 'Data One',
        field: 'DataOne',
        colId: 'DataOne',
        width: 80,
        cellRenderer: (params) => {
            const dataOne = params.data?.DataOne; // optional chaining
            return dataOne ? "✔" : "";
        },
        filter: false,
        sortable: true,
        comparator: (a, b) => {
            // a & b are the raw Story objects
            const aDatOne = a  ? 1 : 0;
            const bDataOne = b ? 1 : 0;
            return aDatOne - bDataOne;
        },
    },
    {
        headerName: '',
        width: 250,
        field: 'action',
        colId: 'action',
        suppressSizeToFit: true, // don't let "fit" shrink this
        cellRenderer: actionsRenderer,
        filter: false,
        sortable: true
    }
    ]

    const gridOptions = {
        rowData: @Html.Raw(JsonConvert.SerializeObject(Model.Inventory.Vehicles)),
        onGridReady: (params) => {
            const $stock = "@ViewBag.Stock";

            gridApi = params.api; // ✅ store reference globally
            gridColumnApi = params.columnApi;

            const firstNode = gridApi.getDisplayedRowAtIndex(0);
            if (firstNode) {
                firstNode.setSelected(true);
            }

            if ($stock !== null && $stock !== "") {
                $("#filterTerm").val($stock);
                applyFilterTerm($stock);
            }

            setTimeout(selectAndClickFirstDisplayedRow, 700);
            const count = gridApi.getDisplayedRowCount();
            $("#filterResults").html(`${count} record(s) found.`);
        },
        columnDefs: columnDefs,
        rowSelection: "single",
        rowHeight: 150, // Set fixed row height in pixels
        suppressRowClickSelection: false, // Allow clicking anywhere in the row
        suppressCellFocus: true, // 🔥 Disable cell selection focus
        pagination: false,
        paginationPageSize: 20,
        multiSortKey: 'ctrl', // or 'shift' (which key you want to hold to multi-sort)
        paginationPageSizeSelector: [20, 50, 100],
        defaultColDef: {
            sortable: true,
            filter: true,
            resizable: true,
            floatingFilter: false,
            minWidth: 120,
            headerClass: 'text-shadow fw-normal td-center'
        },
        onRowClicked: function (event) {
            selectedVehicle = event.data;
            showVehicleDetails(selectedVehicle);
            loadGallery(selectedVehicle);
            setDetails(selectedVehicle.Stock);
            setQrCode(selectedVehicle);
        },
        onFilterChanged: params => {
            const count = gridApi.getDisplayedRowCount();
            $("#filterResults").html(`${count} record(s) found.`);
        }
    };

    const sortable = new Sortable(document.getElementById("sortable-gallery"), {
        scroll: true,
        scrollSensitivity: 30,
        scrollSpeed: 20,
        animation: 150,
        ghostClass: "sortable-gallery-ghost",
        chosenClass: "sortable-gallery-chosen",
        dragClass: "sortable-gallery-drag",
        delay: 100,
        touchStartThreshold: 5,
        onEnd: function (event) {
            let sorted = $("#sortable-gallery li").map(function () {
                return $(this).attr("id")
            }).get();
            saveOrder(sorted, selectedVehicle.Stock);
            updateGalleryDisplay();
        }
    });

    // Delete Icon renderer
    function deleteIconRenderer(params) {
        const icon = document.createElement('span');
        icon.className = 'bi bi-trash fs-5 px-2';
        icon.style.cursor = 'pointer';
        icon.title = `Delete all ${params.data.Images.length} pictures for Stock# ${JSON.stringify(params.data.Stock)}`;

        icon.onclick = () => {
            if (confirm(`Deleting all ${params.data.Images.length} pictures for Stock# ${JSON.stringify(params.data.Stock)}`)) {
                deleteImages(params.data.Stock);
                params.api.applyTransaction({ update: [params.node.data] });
            }
        };
        return icon;
    }

    // Restory Icon renderer
    function reStoryIconRenderer(params) {
        const icon = document.createElement('span');
        icon.className = 'bi bi-book fs-5 px-2';
        icon.style.cursor = 'pointer';
        icon.title = `Create story for Stock# ${JSON.stringify(params.data.Stock)}`;

        icon.onclick = () => {
        const stock = params.data.Stock;
        if (confirm(`Do you want to create story for Stock# ${stock}`)) {
            createStory(params.data.Stock);        }
        };
        params.api.applyTransaction({ update: [params.node.data] });

        return icon;
    }

    // Delete story Icon renderer
    function deleteStoryIconRenderer(params) {
        const icon = document.createElement('span');
        icon.className = 'bi bi-book-fill fs-5 px-2';
        icon.style.cursor = 'pointer';
        icon.title = `Delete story for Stock# ${JSON.stringify(params.data.Stock)}`;

        icon.onclick = () => {
            const stock = params.data.Stock;
            if (confirm(`Do you want to delete story for Stock# ${stock}`)) {
                deleteStory(stock);
            }
            params.api.applyTransaction({ update: [params.node.data] });
        };

        return icon;
    }

    // Image Button Renderer
    function imageButtonRenderer(params) {
        if (!params.data.Images || params.data.Images.length === 0) {
            return `<img class="grid-image" src="${params.data.Image}"></img>`;
        }

        const wrapper = document.createElement('div');
        const image = new Image();;
        image.src = params.data.Image;
        image.className = "grid-image rounded shadow";
        wrapper.appendChild(image)

        return wrapper;
    }

    // Data One Icon renderer
    function dataOneIconRenderer(params) {
        const icon = document.createElement('span');
        icon.className = 'bi bi-car-front fs-5 px-2';
        icon.style.cursor = 'pointer';
        icon.title = `Decode and override for VIN# ${JSON.stringify(params.data.VIN)}`;

        icon.onclick = () => {
            const vin = params.data.VIN;
            if (confirm(`Do you want to decode and override DataOne details for VIN# ${vin}`)) {
                decodeDataOne(vin);
            }
        };
        params.api.applyTransaction({ update: [params.node.data] });

        return icon;
    }

    // Delete DataOne Icon renderer
    function deleteDataOneIconRenderer(params) {
        const icon = document.createElement('span');
        icon.className = 'bi bi-car-front-fill fs-5 px-2';
        icon.style.cursor = 'pointer';
        icon.title = `Delete DataOne for stock# ${JSON.stringify(params.data.Stock)}`;

        icon.onclick = () => {
            const stock = params.data.Stock;
            if (confirm(`Do you want to delete DataOne  for Stock# ${stock}`)) {
                deleteDataOne(stock);
            }
            params.api.applyTransaction({ update: [params.node.data] });
        };

        return icon;
    }

    // Show Bootstrap modal with images
    function showOverlayModal(id) {
        const stock = selectedVehicle.Stock;
        if (stock) {
            showSpinner($("#inventoryOverlay"));
            $.get(`${root}Majordome/OverlayModal`, { id })
                .done(function (html) {
                    $("#vehicle-overlay").html(html);
                    $("#overlayModal").modal("show");
                    hideSpinner($("#inventoryOverlay"));
                })
        };
    }

    function showVehicleDetails(vehicle) {
        $('#vin').val(vehicle.VIN);
        $('#title').val(vehicle.Story?.Title);
        quill.clipboard.dangerouslyPasteHTML(0, vehicle?.Story?.HtmlContent || "");

        if (vehicle.Stock) {
            $.ajax({
                url: '/Majordome/GetDataOneDetails',
                type: 'GET',
                data: { stock: vehicle.Stock },
                success: function (html) {
                    // Replace or inject the partial view HTML
                    $('#dataOneDetails').html(html);
                },
                error: function () {
                    alert("Error loading vehicle details");
                }
            });
        }

        $("#gallery-tab").text(`Photos (${vehicle.Images.length})`);
        $("#QR-code-tab").removeClass("d-none");
    }

    function vehicleDetailsCellRenderer(params) {
        const d = params.data || {};
        return `
        <div class="details"><h6>${d.Year ?? ''} ${d.Make ?? ''}</h6>
        <h7>${d.Model ?? ''} ${d.VehicleStyle ?? ''}</h7></div>
      `;
    }

    function handleFiles(fileList) {
        const files = Array.from(fileList || []).filter(f => {
            const n = (f.name || '').toLowerCase();
            return f.type.startsWith('image/') || /\.(heic|heif|jpg|jpeg|png|webp|gif|bmp|tiff)$/.test(n);
        });
        const stock = selectedVehicle.Stock;
        if (!files.length) return;
        uploadDroppedFiles(stock, files);
    }

    function selectFirstRow(params) {
        params.api.forEachNode(function (node) {
            if (node.rowIndex === 0) {
                node.setSelected(true);
            }
        });
    }

    function selectAndClickFirstDisplayedRow() {
        if (!gridApi) return;

        const firstNode = gridApi.getDisplayedRowAtIndex(0);
        if (!firstNode) return; // no rows (empty after filter)

        // Clear any previous selection
        gridApi.deselectAll();

        // Select the row in AG Grid
        firstNode.setSelected(true);

        // Scroll it into view (optional)
        gridApi.ensureIndexVisible(firstNode.rowIndex, 'top');
        gridOptions.onRowClicked({ data: firstNode.data, node: firstNode });
    }

</script>
