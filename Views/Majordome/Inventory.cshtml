@model GTX.Models.BaseModel
<head>
    <!-- Includes all JS & CSS for the JavaScript Data Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.1/dist/ag-grid-community.min.js"></script>
</head>

<style>
    .ag-paging-panel {
        justify-content: left !important;
    }
</style>
<div id="spinnerOverlay" class="spinner-overlay spinner-hidden">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Working...</span>
    </div>
</div>
<div class="container-fluid">
    <h2 class="mb-4">Inventory Management (Shmeizer)</h2>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                Inventory
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="galery-tab" data-bs-toggle="tab" data-bs-target="#galery" type="button" role="tab">
                Galery
            </button>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0 well " id="myTabContent">
        <!-- Inventory Tab -->
        <div class="tab-pane fade show active" id="inventory" role="tabpanel" style="height: 640px;">
            <div id="myGrid" class="ag-theme-alpine mx-auto" style="height: 580px;">
                <span>@{ Html.RenderPartial("_FilterByTerm"); }</span>
            </div>
        </div>

        <!-- Details Tab -->
        <div class="tab-pane fade mb-2" id="details" role="tabpanel">
            <form id="detailsForm" name="detailsForm" novalidate autocomplete="off" class="w-100">
                <div class="mb-2">
                    @Html.Label("Year", new { @class = "text-shadow" })
                    <input id="year" class="form-control shadow w-25" placeholder="Year" />
                </div>
                <div class="mb-2">
                    @Html.Label("Make", new { @class = "text-shadow" })
                    <input id="make" class="form-control shadow w-25" placeholder="Make" />
                </div>

                <div class="mb-2">
                    @Html.Label("Model", new { @class = "text-shadow" })
                    <input id="model" class="form-control shadow w-25" placeholder="Model" />
                </div>

                <div class="mb-2">
                    @Html.Label("Mileage", new { @class = "text-shadow" })
                    <input id="mileage" class="form-control shadow w-25" placeholder="Mileage" />
                </div>

                <div class="mb-2">
                    @Html.Label("Price", new { @class = "text-shadow" })
                    <input id="price" class="form-control shadow w-25" placeholder="Price" />
                </div>

                <div class="mb-2">
                    @Html.Label("Style", new { @class = "text-shadow" })
                    <input id="style" class="form-control shadow w-25" placeholder="Style" />
                </div>

                <div class="mb-2">
                    @Html.Label("Type", new { @class = "text-shadow" })
                    <input id="type" class="form-control shadow w-25" placeholder="Type" />
                </div>

                <div class="d-flex justify-content-center p-3">
                    <button id="saveDetails" type="submit" class="btn btn-secondary shadow w-50"><i class="bi bi-send"></i> Send</button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="galery" role="tabpanel">
            <h5>Vehicle galery</h5>
            <div id="galery-content" class="container-fluid mb-2">
                <div id="sortable-gallery" class="row">
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div class="modal modal-xl fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-lg-down">
        <div class="modal-content" id="vehicle-details">
        </div>
    </div>
</div>

<template id="addNew">
    <button type="button" id="btnAddNew" class="btn btn-light shadow">Add new</button>
    <button type="button" id="btnReStoryAll" class="btn btn-light shadow">Restory</button>
</template>

<script type="text/javascript">

$(function () {
    var grid = document.querySelector('#myGrid');
    agGrid.createGrid(grid, gridOptions);

    $(".ag-column-last").html($("#addNew").html());

    $("#btnAddNew").on("click", function () {
        $("#details-tab").tab("show");
        $('#details-content').html(
            `<h4>Add new vehicle</h4>
            <input type="search" id="vin" class="form-control w-25 mb-3 shadow" placeholder="Search for VIN #">
            `
        );
    });

    $("#btnReStoryAll").on("click", function () {
        reStoryAll();
    });

    $("#filterLiked").hide();

    $("#vin")
        .on("blur", function () {
            const vin = $(this).val();
            if (vin.length > 0) {
                decodeVin(vin);
            }
        })
        .on("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const vin = $(this).val();
                if (vin.length > 0) {
                    decodeVin(vin);
                }
            }
        }).focus();

    window.addEventListener('resize', function () {
        gridOptions.api.sizeColumnsToFit();
    });

});

let gridApi = null;

const columnDefs = [
    {
        headerName: 'Images',
        field: 'images',
        cellRenderer: imageButtonRenderer,
        filter: false,
        sortable: false
    },
    {
        headerName: "Vehicle",
        filter: false,
        field: "Vehicle", // You can use any placeholder field
        autoHeight: true,
        sortable: true,
        comparator: (valueA, valueB, nodeA, nodeB) => {
            const a = `${nodeA.data.Year} ${nodeA.data.Make} ${nodeA.data.Model}`.toLowerCase();
            const b = `${nodeB.data.Year} ${nodeB.data.Make} ${nodeB.data.Model}`.toLowerCase();

            if (a < b) return -1;
            if (a > b) return 1;
            return 0;
        },
        cellRenderer: (params) => {
            const { Year, Make, Model, VehicleStyle, Mileage, RetailPrice } = params.data;
            var formattedPrice = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(RetailPrice);

            var formattedMileage = new Intl.NumberFormat('en-US').format(Mileage);
            return `
                <div><h7>${Year} ${Make}</h7></div>
                <div style="margin-top: -15px;"><h8>${Model} ${VehicleStyle}</h8></div>
                <div style="margin-top: -15px;"><h8>Miles: ${formattedMileage} Price:${formattedPrice}</h8></div>
        `;
        },
        getQuickFilterText: (params) => {
            const { Year, Make, Model, VehicleStyle, Stock, LocationCode } = params.data;
            return `${Year} ${Make} ${Model} ${VehicleStyle} ${Stock} ${LocationCode}`;
        }
    },
    { headerName: "Stock", field: "Stock", filter: false, width: 120 },
    { headerName: "GTX", field: "LocationCode", filter: false, width: 70  },
    {
        headerName: 'Story',
        field: 'Story',
        width: 400,
        cellRenderer: (params) => {
            if (params.data.Story != null) {
                const { Title, HtmlContent } = params.data.Story;
                return `
                <style>.p-story {font-size: 10px; margin-top: -15px;}</style>
                <div><h7>${Title}</h7></div>
                `
            }
            else {
                return `
                    <h7>No story created</h7>
                `;
            }
        },
        filter: false,
        sortable: true,
        comparator: (valueA, valueB, nodeA, nodeB) => {
            const a = `${nodeA.data.Story.Title}`.toLowerCase();
            const b = `${nodeB.data.Story.Title}`.toLowerCase();

            if (a < b) return -1;
            if (a > b) return 1;
            return 0;
        },
    },
    {
        headerName: '',
        field: 'action',
        cellRenderer: actionsRenderer,
        filter: false,
        sortable: false
    }
]
const gridOptions = {
    rowData: @Html.Raw(Json.Encode(Model.Inventory.Vehicles)),
    onGridReady: (params) => {
        gridApi = params.api; // ✅ store reference globally
    },
    columnDefs: columnDefs,
    rowSelection: 'single', // or 'multiple'
    suppressRowClickSelection: false, // Allow clicking anywhere in the row
    suppressCellFocus: true, // 🔥 Disable cell selection focus
    pagination: true,
    paginationPageSize: 20,
    paginationPageSizeSelector: [20, 50, 100],
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        floatingFilter: false,
        headerClass: 'text-shadow fw-normal td-center'
    },
    onRowDoubleClicked: function (event) {
        showVehicleDetails(event.data);
        loadGallery(event.data.stock);
    },
};

// Delete Icon renderer
function deleteIconRenderer(params) {
    const icon = document.createElement('span');
    icon.className = 'bi bi-trash fs-5 px-2';
    icon.style.cursor = 'pointer';
    icon.title = `Delete all ${params.data.Images.length} pictures for Stock# ${JSON.stringify(params.data.Stock)}`;

    icon.onclick = () => {
        if (confirm(`Deleting all ${params.data.Images.length} pictures for Stock# ${JSON.stringify(params.data.Stock)}`)) {
            deleteImages(params.data.Stock);
            params.api.applyTransaction({ update: [params.node.data] });
        }
    };
    return icon;
}

// Restory Icon renderer
function reStoryIconRenderer(params) {
    const icon = document.createElement('span');
    icon.className = 'bi bi-book fs-5 px-2';
    icon.style.cursor = 'pointer';
    icon.title = `Create story for Stock# ${JSON.stringify(params.data.Stock)}`;

    icon.onclick = () => {
        createStory(params.data.Stock);
        params.api.applyTransaction({ update: [params.node.data] });
    };
    return icon;
}


function deleteImages(stock) {
    $.post(`${root}Majordome/DeleteImages`, { stock })
        .done(function (response) {
            fetch('/Majordome/GetUpdatedItems')
                .then(res => res.json())
                .then(data => {
                    gridApi.setRowData(data);
                });
        })
};

function createStory(stock) {
    showSpinner();
    $.post(`${root}Majordome/CreateStory`, { stock })
        .done(function (response) {
            fetch('/Majordome/GetUpdatedItems')
                .then(res => res.json())
                .then(data => {
                    gridApi.setRowData(data);
                    hideSpinner();
                });
        })
};

// Image Button Renderer
function imageButtonRenderer(params) {
    if (!params.data.Images || params.data.Images.length === 0) {
        return `<img src="${params.data.Image}"></img>`;
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'position-relative d-inline-block';

    const image = new Image();;
    image.title = `Show all ${params.data.Images.length} picture(s) for Stock# ${JSON.stringify(params.data.Stock)}`;
    image.src = params.data.Image;
    wrapper.appendChild(image)

    if (params.data.Images.length > 0) {
        const badge = document.createElement('span');
        badge.className = 'position-absolute badge rounded-pill bg-success start-25';
        badge.textContent = `${params.data.Images.length} images`;
        wrapper.appendChild(badge);
    }

    return wrapper;
}

function storyRenderer(params) {
    if (!params.data.Story) {
        return ""
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'position-relative d-inline-block';

    const title = document.createElement('span');
    title.className = 'position-absolute badge rounded-pill bg-success';
    title.textContent = params.data.Story.Title;
    wrapper.appendChild(title);

    return wrapper;
}

// Show Bootstrap modal with images
function showImageModal(stock) {
    if (stock) {
        $.get(`${root}Inventory/DetailsModal`, { "stock": stock })
            .done(function (html) {
                $("#vehicle-details").html(html);
                $("#detailsModal").modal("show");
            })
    };
}

// File upload jazz
function actionsRenderer(params) {
    const container = document.createElement('div');
    const fileInput = document.createElement('input');

    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.style.display = 'none';

    const icon = document.createElement('span');
    icon.className = 'bi bi-upload fs-5 px-2';
    icon.style.cursor = 'pointer';
    icon.title = `Upload images for Stock# ${JSON.stringify(params.data.Stock)}`;

    icon.onclick = () => {
        fileInput.click();
    };

    fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files);
        if (files.length > 0) {
            uploadFiles(params.data.Stock, fileInput);
        }
    });

    container.appendChild(reStoryIconRenderer(params));
    container.appendChild(icon);
    container.appendChild(fileInput);
    if (params.data.Images && params.data.Images.length > 0) {
        container.appendChild(deleteIconRenderer(params));
    }
    return container;
}

function uploadFiles(stock, input) {
    const files = input.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
    }
    formData.append("stock", stock);

    fetch("/Majordome/Upload", {
        method: "POST",
        body: formData
    })
    .then(response => {
        if (response.ok) {
            fetch('/Majordome/GetUpdatedItems')
                .then(res => res.json())
                .then(data => {
                    gridApi.setRowData(data);
                });
                alert(`Uploaded ${files.length} file(s) for ${stock}`);
        } else {
            alert("Upload failed.");
        }
    })
    .catch(error => {
        alert(error);
    });
}

function decodeVin(vin) {
    fetch('/Inventory/DecodeVin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vin: vin })
    })
    .then(res => res.json())
    .then(data => {
        console.log(data);
        $("#details-content").html(data.Error);
    });
}

function reStoryAll() {
    showSpinner();

    fetch('/Majordome/ReStoryAll', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (response.ok) {
            fetch('/Majordome/GetUpdatedItems')
                .then(res => res.json())
                .then(data => {
                    gridApi.setRowData(data);
                });
            alert(`Restory is done`);
        } else {
            alert("Restory failed.");
        }
        hideSpinner();

    })
    .catch(error => {
        alert(error);
    });
}

function showVehicleDetails(vehicle) {
    $('#details-tab').tab('show');
    $('#year').val(vehicle.Year);
    $('#make').val(vehicle.Make);
    $('#model').val(vehicle.Model);
    $('#year').val(vehicle.Year);
    $('#price').val(vehicle.RetailPrice);
    $('#mileage').val(vehicle.Mileage);
    $('#style').val(vehicle.VehicleStyle);
    $('#type').val(vehicle.VehicleType);
}

function saveDetails(model) {
    fetch('/Majordome/SaveDetails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(model)
    })
        .then(response => {
            if (!response.ok) throw new Error("Server error");
            return response.json();
        })
        .then(data => {
            console.log("✅ Server response:", data);;
        })
        .catch(error => {
            console.log("❌ Error submitting:", error);
        });
    }

    function loadGallery(stock) {
        $.get('/Inventory/GetImages', { stock: stock }, function (images) {
            var container = $("#sortable-gallery");
            container.empty();

            images.forEach(function (imgPath) {
                var fileName = imgPath.split('/').pop();

                var item = `
                <div class="col-md-3 gallery-item" data-filename="${fileName}">
                    <a href="${imgPath}" data-lightbox="gallery">
                        <img src="${imgPath}" class="img-fluid img-thumbnail" />
                    </a>
                    <button class="btn btn-sm btn-danger mt-2 delete-btn" data-stock="${stock}" data-filename="${fileName}">Delete</button>
                </div>
            `;

                container.append(item);
            });

            lightbox.reload();
        });
    }

</script>
