@model List<GTX.Models.EmployeeModel>
<link href="~/Content/majordome.css" rel="stylesheet" />

<div class="shadow rounded-4 overflow-hidden">

    <!-- FIXED HEADER (stays visible) -->
    <div class="card-header bg-white p-3 border-0 sticky-top" style="z-index: 1020;">
        <h4 class="py-3 mb-0">Employee management</h4>

        <div class="d-flex align-items-center justify-content-between flex-nowrap gap-3">
            <!-- Search (left) -->
            <div class="input-group flex-grow-1" style="max-width: 520px;">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input id="empSearch" type="text" class="form-control" placeholder="Search name / email / phone..." />
            </div>

            <!-- Filter + New (right) -->
            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                <select id="empFilter" class="form-select" style="width: 170px;">
                    <option value="all" selected>All</option>
                    <option value="active">Active</option>
                    <option value="notactive">Not Active</option>
                    <option value="withphoto">With Photo</option>
                    <option value="nophoto">No Photo</option>
                </select>

                <a id="newEmployee" class="btn btn-primary"
                   data-employee-modal="true"
                   data-title="New Employee"
                   href="@Url.Action("Create", "Employees")">
                    <i class="bi bi-plus-lg me-1"></i> New
                </a>
            </div>
        </div>
    </div>

    <!-- SCROLL AREA (only table scrolls) -->
    <div class="card-body p-0">
        <div class="table-scroll">
            <table class="table table-hover align-middle m-0" id="empTable">
                <thead class="table-light">
                    <tr>
                        <th style="min-width:90px;">Photo</th>
                        <th style="min-width:170px;">Name</th>
                        <th style="min-width:100px;">Position</th>
                        <th style="min-width:200px;">Email</th>
                        <th style="min-width:140px;">Phone</th>
                        <th style="min-width:90px;">Status</th>
                        <th style="min-width:90px;">Added</th>
                        <th class="text-end" style="width:100px;">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center p-4 text-muted">
                                No employees yet. Click <strong>New</strong> to create one.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var e in Model)
                        {
                            var hasPhoto = !string.IsNullOrWhiteSpace(e.PhotoPath);
                            var active = e.Active;

                            <tr data-hasphoto="@(hasPhoto ? "1" : "0")" data-active="@(active ? "active" : "notactive")">
                                <td>
                                    @if (hasPhoto)
                                    {
                                        <img width="80" height="90" class="rounded-2 border" src="@($"{e.PhotoPath}?h=90")" />
                                    }
                                    else
                                    {
                                        <img width="80" height="90" class="rounded-2 border" src="~/GTXImages/staff/empty.jpg" />
                                    }
                                </td>

                                <td>
                                    <div class="fw-semibold">@e.FirstName @e.LastName</div>
                                </td>

                                <td>@(string.IsNullOrWhiteSpace(e.Position) ? "N/A" : e.Position)</td>
                                <td>@(string.IsNullOrWhiteSpace(e.Email) ? "N/A" : e.Email)</td>
                                <td>@(string.IsNullOrWhiteSpace(e.Phone) ? "N/A" : e.Phone)</td>

                                <td>
                                    @if (e.Active)
                                    {
                                        <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle shadow">
                                            Active
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-secondary-subtle text-secondary border border-secondary-subtle">
                                            Inactive
                                        </span>
                                    }
                                </td>

                                <td>@e.CreatedDate.ToString("MM/dd/yyyy")</td>

                                <td class="text-end">
                                    <div class="btn-group">
                                        <a class="btn btn-gradient-grey btn-sm btn-outline-primary"
                                           data-employee-modal="true"
                                           data-title="Edit Employee"
                                           href="@Url.Action("Edit", "Employees", new { id = e.Id })">
                                            <i class="bi bi-pencil-square me-1"></i>
                                        </a>

                                        <button id="btnDeleteEmp-@e.Id"
                                                type="button"
                                                class="btn btn-gradient-grey btn-sm btn-outline-danger"
                                                onclick="deleteEmployee(@e.Id)"
                                                data-id="@e.Id"
                                                title="Delete">
                                            <i class="bi bi-trash me-1"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    function getEmpEls() {
        return {
            search: document.getElementById('empSearch'),
            filter: document.getElementById('empFilter'),
            table: document.getElementById('empTable')
        };
    }

    function deleteEmployee(id) {
        if (!id) return;

        if (!confirm("Delete this employee? This cannot be undone.")) return;

        $.post(`${root}Employees/Delete`, { id: id })
            .done(function (res) {
                refreshEmployees();
            })
            .fail(function (xhr) {
                alert("Delete failed. Status: " + xhr.status);
            });
    };

    function refreshEmployees() {
        const term = $("#empSearch").val() || "";
        const mode = $("#empFilter").val() || "all";
        const listContainerSelector = "#tab-employees";

        $(listContainerSelector).load(`${root}Employees/ListPartial`, function () {
            $("#empSearch").val(term);
            $("#empFilter").val(mode).trigger("change");
            $("#empSearch").trigger("input");
        });
    }

    function applyEmployees() {
        const { search, filter, table } = getEmpEls();
        if (!search || !filter || !table) return;

        const term = (search.value || '').toLowerCase().trim();
        const mode = (filter.value || 'all').toLowerCase();

        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(r => {
            // keep your "group/header" rows visible
            if (r.children.length === 1) return;

            const hasPhoto = r.getAttribute('data-hasphoto') === '1';
            const activeState = (r.getAttribute('data-active') || '').toLowerCase(); // "active" | "notactive"

            const name = (r.querySelector('td:nth-child(2)')?.innerText || '').toLowerCase();
            const position = (r.querySelector('td:nth-child(3)')?.innerText || '').toLowerCase();
            const email = (r.querySelector('td:nth-child(4)')?.innerText || '').toLowerCase();
            const phone = (r.querySelector('td:nth-child(5)')?.innerText || '').toLowerCase();

            const hay = `${name} ${position} ${email} ${phone} ${activeState}`.trim();
            const matchText = !term || hay.includes(term);

            let matchFilter = true;
            switch (mode) {
                case 'withphoto':
                    matchFilter = hasPhoto;
                    break;
                case 'nophoto':
                    matchFilter = !hasPhoto;
                    break;
                case 'active':
                    matchFilter = activeState === 'active';
                    break;
                case 'notactive':
                    matchFilter = activeState === 'notactive';
                    break;
                case 'all':
                default:
                    matchFilter = true;
                    break;
            }

            r.style.display = (matchText && matchFilter) ? '' : 'none';
        });
    }


    $(document).on('input', '#empSearch', applyEmployees);
    $(document).on('change', '#empFilter', applyEmployees);

    $(applyEmployees);
</script>
