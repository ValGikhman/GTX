
@model List<GTX.Models.EmployeeModel>

<div class="card-header bg-white p-3 m-3 rounded-3 shadow">
    <h4 class="py-3">Employee management</h4>

    <div class="d-flex align-items-center justify-content-between flex-nowrap">
        <!-- Search (left) -->
        <div class="input-group flex-grow-1" style="max-width: 520px;">
            <span class="input-group-text bg-white">
                <i class="bi bi-search"></i>
            </span>
            <input id="empSearch" type="text" class="form-control" placeholder="Search name / email / phone..." />
        </div>

        <!-- Filter + New (right) -->
        <div class="d-flex align-items-center gap-2 flex-shrink-0">
            <select id="empFilter" class="form-select" style="width: 170px;">
                <option value="all" selected>All</option>
                <option value="withphoto">With Photo</option>
                <option value="nophoto">No Photo</option>
            </select>

            <a id="newEmployee" class="btn btn-primary" data-employee-modal="true" data-title="New Employee" href="@Url.Action("Create", "Employees")">
                <i class="bi bi-plus-lg me-1"></i> New
            </a>
        </div>
    </div>
</div>

<div class="card-body p-3">
    <div class="table-responsive rounded-3 shadow">
        <table class="table table-hover align-middle m-0" id="empTable">
            <thead class="table-light">
                <tr>
                    <th style="min-width:90px;">Photo</th>
                    <th style="min-width:170px;">Name</th>
                    <th style="min-width:160px;">Position</th>
                    <th style="min-width:200px;">Email</th>
                    <th style="min-width:140px;">Phone</th>
                    <th class="text-end" style="width:260px;">Actions</th>
                </tr>
            </thead>

            <tbody>
                @if (Model == null || !Model.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center p-4 text-muted">
                            No employees yet. Click <strong>New</strong> to create one.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var e in Model)
                    {
                        var hasPhoto = !string.IsNullOrWhiteSpace(e.PhotoPath);

                        <tr data-hasphoto="@(hasPhoto ? "1" : "0")">
                            <td>
                                @if (hasPhoto)
                                {
                                    <img width="90" height="90" class="rounded-2 border" src="@($"{e.PhotoPath}?h=90")" />
                                }
                                else
                                {
                                    <img width="90" height="90" class="rounded-2 border" src="/images/placeholder-person.png" />
                                }
                            </td>

                            <td>
                                <div class="fw-semibold">@e.FirstName @e.LastName</div>
                            </td>

                            <td>@(string.IsNullOrWhiteSpace(e.Position) ? "N/A" : e.Position)</td>

                            <td>@(string.IsNullOrWhiteSpace(e.Email) ? "N/A" : e.Email)</td>

                            <td>@(string.IsNullOrWhiteSpace(e.Phone) ? "N/A" : e.Phone)</td>

                            <td class="text-end">
                                <div class="btn-group">
                                    <a class="btn btn-gradient-grey btn-sm btn-outline-primary"
                                       data-employee-modal="true"
                                       data-title="Edit Employee"
                                       href="@Url.Action("Edit", "Employees", new { id = e.Id })">
                                        <i class="bi bi-pencil-square me-1"></i>
                                    </a>

                                    <button id="btnDeleteEmp-@e.Id" type="button" class="btn btn-gradient-grey btn-sm btn-outline-danger" onclick="deleteEmployee(@e.Id)" data-id="@e.Id" title="Delete">
                                        <i class="bi bi-trash me-1"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function getEmpEls() {
        return {
            search: document.getElementById('empSearch'),
            filter: document.getElementById('empFilter'),
            table: document.getElementById('empTable')
        };
    }

    function deleteEmployee(id) {
        if (!id) return;

        if (!confirm("Delete this employee? This cannot be undone.")) return;

        $.post(`${root}Employees/Delete`, { id: id })
            .done(function (res) {
                refreshEmployees();
            })
            .fail(function (xhr) {
                alert("Delete failed. Status: " + xhr.status);
            });
    };

    function refreshEmployees() {
        const term = $("#empSearch").val() || "";
        const mode = $("#empFilter").val() || "all";
        const listContainerSelector = "#tab-employees"; // change to your container

        $(listContainerSelector).load(`${root}Employees/ListPartial`, function () {
            $("#empSearch").val(term);
            $("#empFilter").val(mode).trigger("change");
            $("#empSearch").trigger("input");
        });
    }

    function applyEmployees() {
        const { search, filter, table } = getEmpEls();
        if (!search || !filter || !table) return;

        const term = (search.value || '').toLowerCase().trim();
        const mode = filter.value;

        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(r => {
            // Skip "No employees yet..." row (colspan row)
            if (r.children.length === 1) return;

            const hasPhoto = r.getAttribute('data-hasphoto') === '1';

            const name = (r.querySelector('td:nth-child(2)')?.innerText || '').toLowerCase();
            const position = (r.querySelector('td:nth-child(3)')?.innerText || '').toLowerCase();
            const email = (r.querySelector('td:nth-child(4)')?.innerText || '').toLowerCase();
            const phone = (r.querySelector('td:nth-child(5)')?.innerText || '').toLowerCase();

            const hay = (name + ' ' + position + ' ' + email + ' ' + phone).trim();
            const matchText = !term || hay.includes(term);

            const matchFilter =
                mode === 'all' ||
                (mode === 'withphoto' && hasPhoto) ||
                (mode === 'nophoto' && !hasPhoto);

            r.style.display = (matchText && matchFilter) ? '' : 'none';
        });
    }

    $(document).on('input', '#empSearch', applyEmployees);
    $(document).on('change', '#empFilter', applyEmployees);

    $(applyEmployees);
</script>
