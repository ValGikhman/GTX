@model GTX.Models.BlogPostModel
@{
    var isEdit = Model != null && Model.Id > 0;
    var action = isEdit ? "Save" : "Create";
    var htmlAttrs = new Dictionary<string, object>
{
        { "data-blog-ajax", "true" }
    };
}
@using (Html.BeginForm(action, "Blogs", FormMethod.Post, htmlAttrs))
{
    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.CreatedAt)

    <div class="container-fluid p-0">
        <div class="border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white border-bottom p-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-2 text-shadow-small">
                        <i class="bi bi-journal-text fs-4 text-primary"></i>
                        <div>
                            <div class="fw-semibold fs-5 mb-0 text-shadow-small">@(isEdit ? "Edit Post" : "Create Post")</div>
                            <div class="text-muted small">Compose content, attach links, and preview media.</div>
                        </div>
                    </div>

                    <div class="form-check form-switch m-0 text-shadow-small">
                        @Html.CheckBoxFor(m => m.IsPublished, new { @class = "form-check-input", id = "IsPublished" })
                        <label class="form-check-label fw-semibold" for="IsPublished">
                            Published
                        </label>
                    </div>
                </div>
            </div>

            <div class="card-body p-3">
                <div class="row g-4">

                    <!-- Article URL -->
                    <div class="col-12">
                        <label class="form-label fw-semibold text-shadow-small">
                            <i class="bi bi-link-45deg me-1 text-primary"></i> Article URL <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-globe2 text-secondary"></i>
                            </span>
                            @Html.TextBoxFor(m => m.ArticleURL, new { @class = "form-control", type = "url", id = "ArticleUrl", placeholder = "https://example.com/article.html" })
                        </div>
                        <div class="form-text">Paste a direct article link.</div>
                    </div>

                    <!-- Media URL -->
                    <div class="col-12">
                        <label class="form-label fw-semibold text-shadow-small">
                            <i class="bi bi-image me-1 text-primary"></i> Image URL <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-camera text-secondary"></i>
                            </span>
                            @Html.TextBoxFor(m => m.MediaURL, new { @class = "form-control", type = "url", id = "MediaUrl", placeholder = "https://example.com/photo.jpg" })
                        </div>
                        <div class="form-text">Paste a direct image link (jpg/png/webp/gif).</div>
                    </div>

                    <!-- Preview -->
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label fw-semibold mb-2 text-shadow-small">
                                <i class="bi bi-eye me-1 text-primary"></i> Image Preview
                            </label>
                            <span class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle">
                                Live preview
                            </span>
                        </div>

                        <div class="border rounded-4 bg-light shadow-sm overflow-hidden position-relative" style="height:260px;">
                            <!-- subtle top gradient overlay -->
                            <div class="position-absolute top-0 start-0 end-0" style="height:72px; background: linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,0));"></div>

                            <img id="imagePreview"
                                 alt="Image preview"
                                 class="w-100 h-100"
                                 style="object-fit:cover;"
                                 src="/images/placeholder-car.jpg" />

                            <div class="position-absolute bottom-0 start-0 end-0 p-2">
                                <div class="small text-white-50">
                                    <i class="bi bi-info-circle me-1"></i> Invalid/empty URL hides the image.
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-1" />

                    <!-- Title -->
                    <div class="col-md-7">
                        <label class="form-label fw-semibold text-shadow-small">
                            <i class="bi-person-badge me-1 text-primary"></i> Title
                        </label>
                        @Html.TextBoxFor(m => m.Title, new { @class = "form-control shadow-sm", maxlength = "200", placeholder = "Post title..." })
                        @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger small" })
                    </div>

                    <!-- Author -->
                    <div class="col-md-5">
                        <label class="form-label fw-semibold text-shadow-small">
                            <i class="bi bi-person-badge me-1 text-primary"></i> Author
                        </label>
                        @Html.TextBoxFor(m => m.Author, new { @class = "form-control shadow-sm", placeholder = "Optional" })
                    </div>

                    <!-- Content -->
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label fw-semibold mb-2 text-shadow-small">
                                <i class="bi bi-pencil-square me-1 text-primary"></i> Content
                            </label>
                            <span class="text-muted small">
                                <i class="bi bi-lightning-charge me-1"></i> Rich editor enabled
                            </span>
                        </div>

                        @Html.HiddenFor(m => m.Content, new { id = "Content" })

                        <div class="shadow-sm rounded-3 overflow-hidden border">
                            <div id="contentEditor" class="form-control border-0" style="height:260px"></div>
                        </div>

                        @Html.ValidationMessageFor(m => m.Content, "", new { @class = "text-danger small" })
                    </div>

                    @Html.ValidationSummary(false, "", new { @class = "text-danger mt-2" })

                    <!-- Actions -->
                    <div class="col-12 d-flex justify-content-end gap-2 pt-2">
                        <button type="button" class="btn btn-outline-secondary px-3 shadow" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary px-3 shadow">
                            <i class="bi bi-check2-circle me-1"></i> @(isEdit ? "Save Changes" : "Create Post")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<script>
    $(function () {
        var $form = $('form[data-blog-ajax="true"]');
        if (!$form.length) $form = $('form').first();

        // -----------------------------
        // Quill
        // -----------------------------
        var quill = new Quill('#contentEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ header: [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        function normalizeEmpty(html) {
            var h = $.trim(html || '');
            return (h === '<p><br></p>' || h === '<div><br></div>') ? '' : h;
        }

        function syncContent() {
            var html = normalizeEmpty(quill.root.innerHTML);
            $('#Content', $form).val(html);
        }

        // Load existing content (Edit mode)
        var initialHtml = $('#Content', $form).val();
        if (initialHtml) quill.clipboard.dangerouslyPasteHTML(initialHtml);

        // Sync on any submit (delegated helps if form is injected)
        $(document).on('submit', 'form[data-blog-ajax="true"]', function () {
            syncContent();
        });

        // Extra safety: sync on click (some AJAX serializers grab values on click)
        $form.on('click', 'button[type=submit], input[type=submit]', function () {
            syncContent();
        });

        // -----------------------------
        // Media URL -> Image Preview
        // -----------------------------
        const allowed = ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg"];

        function isValidUrl(s) {
            try { new URL(s); return true; } catch (e) { return false; }
        }

        function getExt(url) {
            try {
                const u = new URL(url);
                const path = (u.pathname || "").toLowerCase();
                const m = path.match(/\.([a-z0-9]+)$/);
                return m ? m[1] : "";
            } catch (e) { return ""; }
        }

        function setPreview(url) {
            const img = document.getElementById("imagePreview");
            if (!img) return;

            if (!url) {
                img.removeAttribute("src");
                img.style.display = "none"; // keep the box visible, hide only the img
                return;
            }

            // Cache-bust so changes always refresh
            const bust = (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();

            img.style.display = "";
            img.onerror = function () {
                img.removeAttribute("src");
                img.style.display = "none";
            };
            img.src = url + bust;
        }

        function renderPreviewFromInputValue(value) {
            const url = (value || "").trim();
            if (!url || !isValidUrl(url)) return setPreview('');

            const ext = getExt(url);
            if (!allowed.includes(ext)) return setPreview(''); // image-only

            setPreview(url);
        }

        // Use delegated events so it works even when partial is loaded into a modal later
        $(document).on('input change paste', '#MediaUrl', function () {
            renderPreviewFromInputValue(this.value);
        });

        // Initial render (edit mode)
        renderPreviewFromInputValue($('#MediaUrl').val());
        syncContent();
    });
</script>
