@model GTX.Models.BlogPostModel
@{
    var isEdit = Model != null && Model.Id > 0;
    var action = isEdit ? "Save" : "Create";
    var htmlAttrs = new Dictionary<string, object>
{
        { "data-blog-ajax", "true" }
    };
}

@using (Html.BeginForm(action, "BlogPosts", FormMethod.Post, htmlAttrs))
{

    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.CreatedAt)

    <div class="mb-3">
        <label class="form-label text-shadow-small"><strong>Title</strong></label>
        @Html.TextBoxFor(m => m.Title, new { @class = "form-control shadow", maxlength = "200", placeholder = "Post title..." })
        @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label text-shadow-small"><strong>Author</strong></label>
            @Html.TextBoxFor(m => m.Author, new { @class = "form-control shadow", placeholder = "Optional" })
        </div>

        <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
                @Html.CheckBoxFor(m => m.IsPublished, new { @class = "form-check-input" })
                <label class="form-check-label text-shadow-small" for="IsPublished">Published</label>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="mb-3">
            <label class="form-label text-shadow-small"><strong>Article URL (optional)</strong></label>
            @Html.TextBoxFor(m => m.ArticleURL, new { @class = "form-control shadow", type = "url", id = "ArticleUrl", placeholder = "https://example.com/article.html" })
            <div class="form-text">Paste a direct article link.</div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="mb-3">
            <label class="form-label text-shadow-small"><strong>Image URL (optional)</strong></label>
            @Html.TextBoxFor(m => m.MediaURL, new { @class = "form-control shadow", type = "url", id = "MediaUrl", placeholder = "https://example.com/photo.jpg" })
            <div class="form-text">Paste a direct image link (jpg/png/webp/gif).</div>
        </div>
    </div>

    <div id="imagePreviewBox" class="border rounded-3 p-2 bg-light d-none">
        <img id="@using (Html.BeginForm(action, "BlogPosts", FormMethod.Post, htmlAttrs))
{

    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.CreatedAt)

    <div class="mb-3">
        <label class="form-label text-shadow-small"><strong>Title</strong></label>
        @Html.TextBoxFor(m => m.Title, new { @class = "form-control shadow", maxlength = "200", placeholder = "Post title..." })
        @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label text-shadow-small"><strong>Author</strong></label>
            @Html.TextBoxFor(m => m.Author, new { @class = "form-control shadow", placeholder = "Optional" })
        </div>

        <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
                @Html.CheckBoxFor(m => m.IsPublished, new { @class = "form-check-input" })
                <label class="form-check-label text-shadow-small" for="IsPublished">Published</label>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="mb-3">
            <label class="form-label text-shadow-small"><strong>Article URL (optional)</strong></label>
            @Html.TextBoxFor(m => m.ArticleURL, new { @class = "form-control shadow", type = "url", id = "ArticleUrl", placeholder = "https://example.com/article.html" })
            <div class="form-text">Paste a direct article link.</div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="mb-3">
            <label class="form-label text-shadow-small"><strong>Image URL (optional)</strong></label>
            @Html.TextBoxFor(m => m.MediaURL, new { @class = "form-control shadow", type = "url", id = "MediaUrl", placeholder = "https://example.com/photo.jpg" })
            <div class="form-text">Paste a direct image link (jpg/png/webp/gif).</div>
        </div>
    </div>

    <div id="imagePreviewBox" class="border rounded-3 p-2 bg-light d-none">
        <img id="imagePreview" class="img-fluid rounded" alt="Image preview" />
    </div>

    <div class="row g-3 mb-3">
        <div class="mt-3">
            <label class="form-label text-shadow-small"><strong>Content</strong></label>
            @Html.HiddenFor(m => m.Content, new { id = "Content" })
            <div id="contentEditor" class="form-control shadow" style="height: 200px"></div>
            @Html.ValidationMessageFor(m => m.Content, "", new { @class = "text-danger" })
        </div>
    </div>

    @Html.ValidationSummary(false, "", new { @class = "text-danger mt-3" })

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">@(isEdit ? "Save Changes" : "Create Post")</button>
    </div>
}" class="img-fluid rounded" alt="Image preview" />
    </div>

    <div class="row g-3 mb-3">
        <div class="mt-3">
            <label class="form-label text-shadow-small"><strong>Content</strong></label>
            @Html.HiddenFor(m => m.Content, new { id = "Content" })
            <div id="contentEditor" class="form-control shadow" style="height: 200px"></div>
            @Html.ValidationMessageFor(m => m.Content, "", new { @class = "text-danger" })
        </div>
    </div>

    @Html.ValidationSummary(false, "", new { @class = "text-danger mt-3" })

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">@(isEdit ? "Save Changes" : "Create Post")</button>
    </div>
}

<script>
    $(function () {
        var $form = $('form[data-blog-ajax="true"]');
        if (!$form.length) $form = $('form').first();

        var quill = new Quill('#contentEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ header: [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Load existing content (Edit mode)
        var initialHtml = $('#Content', $form).val();
        if (initialHtml) quill.clipboard.dangerouslyPasteHTML(initialHtml);

        $(document).on('submit', 'form[data-blog-ajax="true"]', function () {
            $('#Content').val(normalizeEmpty(quill.root.innerHTML));
        });

        const input = document.getElementById("MediaUrl");
        const box = document.getElementById("imagePreviewBox");
        const img = document.getElementById("imagePreview");
        if (!input || !box || !img) return;

        const allowed = ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg"];

        $form.on('submit', function () {
            syncContent();
        });

        // ✅ Also sync when the submit button is clicked (some scripts serialize on click)
        $form.on('click', 'button[type=submit], input[type=submit]', function () {
            syncContent();
        });

        function syncContent() {
            var html = normalizeEmpty(quill.root.innerHTML);
            $('#Content', $form).val(html);
        }

        function normalizeEmpty(html) {
            var h = $.trim(html || '');
            return (h === '<p><br></p>' || h === '<div><br></div>') ? '' : h;
        }

        function isValidUrl(s) {
            try { new URL(s); return true; } catch { return false; }
        }

        function getExt(url) {
            try {
                const u = new URL(url);
                const path = (u.pathname || "").toLowerCase();
                const m = path.match(/\.([a-z0-9]+)$/);
                return m ? m[1] : "";
            } catch { return ""; }
        }

        function hide() {
            img.removeAttribute("src");
            box.classList.add("d-none");
        }

        function show(url) {
            img.src = url;
            box.classList.remove("d-none");
        }

        function render() {
            const url = (input.value || "").trim();
            if (!url || !isValidUrl(url)) return hide();

            const ext = getExt(url);
            if (!allowed.includes(ext)) return hide(); // image-only

            show(url);
        }

        img.addEventListener("error", hide); // invalid/broken image URL
        input.addEventListener("input", render);
        input.addEventListener("change", render);

        render();
        syncContent();
    })
</script>
