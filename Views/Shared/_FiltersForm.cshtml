@{ Html.RenderPartial("_CategoryFilter"); }

@*Meat*@
<div class="row container-fluid mt-2 col-12 justify-content-between">
    <div id="filterOverlay" class="spinner-overlay spinner-hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    @*Search*@
    <div class="p-3 well">
        @{Html.RenderPartial("_SearchByTerm");}
    </div>
    <div class="p-1 well" title="Searching inventory by make">
        @{Html.RenderPartial("_MakesFilter");}
    </div>

    @{Html.RenderPartial("_FilterTools");}
</div>

<script type="text/javascript">
    $(function () {
        $("#makes").chosen({
            placeholder_text_multiple: "All make(s)...",
            no_results_text: "No makes for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allMakes").prop({ checked: setValue, disabled: setValue });

            if (selected && selected.length == 0) {
                $("#models").prop({ disabled: true }).trigger("chosen:updated");
                showOthers(false);
                updateData();
            }
            else if ((selected && selected.length == 1)) {
                $("#models").prop({ disabled: false }).trigger("chosen:updated");
                showOthers(false);
                updateData(selected);
            }
            else if (selected && selected.length > 1) {
                $("#models").prop({ disabled: true }).trigger("chosen:updated");
                showOthers(true);
                updateData(selected);
            }
        });

        $("#models").chosen({
            placeholder_text_multiple: "All model(s)...",
            no_results_text: "No model for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allModels").prop({ checked: setValue, disabled: setValue });
        });

        $("#cylinders").chosen({
            placeholder_text_multiple: "All cylinders...",
            no_results_text: "No cylinders for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allCylinders").prop({ checked: setValue, disabled: setValue });
        });

        $("#transmissions").chosen({
            placeholder_text_multiple: "All transmissions(s)...",
            no_results_text: "No transmission for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allTransmissions").prop({ checked: setValue, disabled: setValue });
        });

        $("#fuelTypes").chosen({
            placeholder_text_multiple: "All fuel type(s)...",
            no_results_text: "No fuel type for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allFuelTypes").prop({ checked: setValue, disabled: setValue });
        });

        $("#drives").chosen({
            placeholder_text_multiple: "All drive train(s)...",
            no_results_text: "No drive train for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allDrives").prop({ checked: setValue, disabled: setValue });
        });

        $("#bodyTypes").chosen({
            placeholder_text_multiple: "All body types(s)...",
            no_results_text: "No body type for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allBodyTypes").prop({ checked: setValue, disabled: setValue });
        });

        $("#vehicleTypes").chosen({
            placeholder_text_multiple: "All vehicle type(s)...",
            no_results_text: "No vehicle type for search criteria"
        }).on("change", function () {
            const selected = $(this).val();
            const setValue = (selected && selected.length === 0);
            $("#allVehicleTypes").prop({ checked: setValue, disabled: setValue });
        });

        $("#allMakes").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#makes").data({ placeholder_text_multiple: "All make(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#makes").data({ placeholder_text_multiple: "Click to select make(s)..." }).trigger('chosen:updated');
            }
        });

        $("#allModels").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#models").data({ placeholder_text_multiple: "All model(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#models").data({ placeholder_text_multiple: "Click to select model(s)..." }).trigger('chosen:updated');;
            }
        });

        $("#allCylinders").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#cylinders").data({ placeholder_text_multiple: "All cylinders..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#cylinders").data({ placeholder_text_multiple: "Click to select cylinders..." }).trigger('chosen:updated');;
            }
        });

        $("#allTransmissions").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#transmissions").data({ placeholder_text_multiple: "All transmission(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#transmissions").data({ placeholder_text_multiple: "Click to select transmission(s)..." }).trigger('chosen:updated');;
            }
        });

        $("#allDrives").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#drives").data({ placeholder_text_multiple: "All drive trains(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#drives").data({ placeholder_text_multiple: "Click to select drive trains(s)..." }).trigger('chosen:updated');;
            }
        });

        $("#allBodyTypes").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#bodyTypes").data({ placeholder_text_multiple: "All body type(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#bodyTypes").data({ placeholder_text_multiple: "Click to select body types(s)..." }).trigger('chosen:updated');;
            }
        });

        $("#allFuelTypes").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);
            if (this.checked) {
                $("#fuelTypes").data({ placeholder_text_multiple: "All fuel type(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#fuelTypes").data({ placeholder_text_multiple: "Click to select fuel type(s)..." }).trigger('chosen:updated');;
            }
        });

        $("#allVehicleTypes").prop({ disabled: true }).on("change", function () {
            $(this).prop("disabled", this.checked);

            if (this.checked) {
                $("#vehicleTypes").data({ placeholder_text_multiple: "All vehicle type(s)..." }).val([]).trigger('chosen:updated');
            }
            else {
                $("#vehicleTypes").data({ placeholder_text_multiple: "Click to select vehicle types(s)..." }).trigger('chosen:updated');;
            }
        });

        getMakes();
        updateData();

        $(".chosen-choices").addClass("shadow rounded p-0");
        $(".chosen-container").addClass("w-100 p-1");

        $("#btnSearch").on("click", function () {
            showSpinner($("#filterOverlay"));
            var model = {
                Makes: $("#makes").val(),
                Models: $("#models").val(),
                Cylinders: $("#cylinders").val(),
                Transmissions: $("#transmissions").val(),
                FuelTypes: $("#fuelTypes").val(),
                VehicleTypes: $("#vehicleTypes").val(),
                DriveTrains: $("#drives").val(),
                BodyTypes: $("#bodyTypes").val(),
                MaxMilege: $("#milege").slider("values", 1),
                MinMilege: $("#milege").slider("values", 0),
                MaxPrice: $("#price").slider("values", 1),
                MinPrice: $("#price").slider("values", 0)
            };

            $("#filtersModal [data-bs-dismiss='modal']").trigger("click");

            $.ajax({
                url: `${root}Inventory/ApplyFilter`,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(model)   // ✅ send the model itself, not { model: model }
            })
            .done(function (response) {
                //hideSpinner($("#filterOverlay"));
   
                window.location.href = response.redirectUrl;
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error, xhr.responseText);
            });
        })
    })

    getMakes = function () {
        $.get(`${root}Inventory/GetMakes`)
            .done(function (result) {
                const $selector = $("#makes");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getModels = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetModels`, { makes: makes })
            .done(function (result) {
                const $selector = $("#models");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getCylinders = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetCylinders`, { makes: makes })
            .done(function (result) {
                const $selector = $("#cylinders");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getTransmissions = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetTransmissions`, { makes: makes })
            .done(function (result) {
                const $selector = $("#transmissions");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getFuelTypes = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetFuelTypes`, { makes: makes })
            .done(function (result) {
                const $selector = $("#fuelTypes");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getDrives = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetDrives`, { makes: makes })
            .done(function (result) {
                const $selector = $("#drives");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });
    }

    getBodyTypes = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetBodyTypes`, { makes: makes })
            .done(function (result) {
                const $selector = $("#bodyTypes");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });

    }

    getVehicleTypes = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetVehicleTypes`, { makes: makes })
            .done(function (result) {
                const $selector = $("#vehicleTypes");
                updateChosen(result, $selector);
            })
            .fail(function (xhr, status, error) {
                hideSpinner($("#filterOverlay"));
                console.error("Error applying term:", error);
            });

    }

    getPriceRange = function (makes) {
        $.ajaxSettings.traditional = true;
        showSpinner($("#filterOverlay"));

        $.get(`${root}Inventory/GetPriceRange`, { makes: makes })
            .done(function (result) {
                if (result != null) {
                    const roundedMin = Math.round(Math.floor(result.PriceMin / 1000)) * 1000;
                    const roundedMax = Math.round(Math.ceil(result.PriceMax / 1000)) * 1000;

                    const formattedMin = new Intl.NumberFormat('en-US', {
                        maximumFractionDigits: 0,
                        minimumFractionDigits: 0,
                        style: 'currency',
                        currency: 'USD'
                    }).format(roundedMin);


                    const formattedMax = new Intl.NumberFormat('en-US', {
                        maximumFractionDigits: 0,
                        minimumFractionDigits: 0,
                        style: 'currency',
                        currency: 'USD'
                    }).format(roundedMax);

                    $("#priceMin").text(formattedMin);
                    $("#priceMax").text(formattedMax);
                    $("#price").slider({
                        range: true,
                        min: roundedMin,
                        max: roundedMax,
                        values: [roundedMin, roundedMax],
                        slide: function (event, ui) {
                            const roundedMin = Math.round(ui.values[0] / 1000) * 1000;
                            const roundedMax = Math.round(ui.values[1] / 1000) * 1000;
                            const formattedMin = new Intl.NumberFormat('en-US', {
                                maximumFractionDigits: 0,
                                minimumFractionDigits: 0,
                                style: 'currency',
                                currency: 'USD'
                            }).format(roundedMin);

                            const formattedMax = new Intl.NumberFormat('en-US', {
                                maximumFractionDigits: 0,
                                minimumFractionDigits: 0,
                                style: 'currency',
                                currency: 'USD'
                            }).format(roundedMax);

                            $("#priceMin").text(`More than ${formattedMin}`);
                            $("#priceMax").text(`Under ${formattedMax}`);
                        }
                    });
                }
                hideSpinner($("#filterOverlay"));
            })
    }

    getMilege = function (makes) {
        $.ajaxSettings.traditional = true;
        $.get(`${root}Inventory/GetMilegeRange`, { makes: makes })
            .done(function (result) {
                if (result != null) {
                    const roundedMin = Math.round(Math.floor(result.MilesMin / 1000)) * 1000;
                    const roundedMax = Math.round(Math.ceil(result.MilesMax / 1000)) * 1000;
                    const formattedMin = new Intl.NumberFormat('en-US', {
                        maximumFractionDigits: 0,
                        minimumFractionDigits: 0,
                    }).format(roundedMin);


                    const formattedMax = new Intl.NumberFormat('en-US', {
                        maximumFractionDigits: 0,
                        minimumFractionDigits: 0,
                    }).format(roundedMax);

                    $("#milegeMin").text(formattedMin);
                    $("#milegeMax").text(formattedMax);
                    $("#milege").slider({
                        range: true,
                        min: roundedMin,
                        max: roundedMax,
                        values: [roundedMin, roundedMax],
                        slide: function (event, ui) {
                            const roundedMin = Math.round(ui.values[0] / 1000) * 1000;
                            const roundedMax = Math.round(ui.values[1] / 1000) * 1000;
                            const formattedMin = new Intl.NumberFormat('en-US', {
                                maximumFractionDigits: 0,
                                minimumFractionDigits: 0,
                            }).format(roundedMin);

                            const formattedMax = new Intl.NumberFormat('en-US', {
                                maximumFractionDigits: 0,
                                minimumFractionDigits: 0,
                            }).format(roundedMax);

                            $("#milegeMin").text(`More than ${formattedMin}`);
                            $("#milegeMax").text(`Under ${formattedMax}`);
                        }
                    });
                }
                hideSpinner($("#filterOverlay"));
            })
    }

    function updateData(selected) {
        clearData();

        getModels(selected);
        getCylinders(selected);
        getTransmissions(selected);
        
        getFuelTypes(selected);
        getPriceRange(selected);
        getDrives(selected);
        getBodyTypes(selected);
        getVehicleTypes(selected);
        getMilege(selected);

        getPriceRange(selected);
        getMilege(selected);
    }

    function clearData() {
        $("#models").val([]).empty().trigger("chosen:updated");
        $("#cylinders").val([]).empty().trigger("chosen:updated");
        $("#transmissions").val([]).empty().trigger("chosen:updated");
        $("#fuelTypes").val([]).empty().trigger("chosen:updated");
        $("#vehicleTypes").val([]).empty().trigger("chosen:updated");
        $("#drives").val([]).empty().trigger("chosen:updated");
        $("#bodyTypes").val([]).empty().trigger("chosen:updated");
    }

    function showOthers(disabled) {
        $("#cylinders").prop({ disabled: disabled }).trigger("chosen:updated");
        $("#transmissions").prop({ disabled: disabled }).trigger("chosen:updated");
        $("#fuelTypes").prop({ disabled: disabled }).trigger("chosen:updated");
        $("#vehicleTypes").prop({ disabled: disabled }).trigger("chosen:updated");
        $("#drives").prop({ disabled: disabled }).trigger("chosen:updated");
        $("#bodyTypes").prop({ disabled: disabled }).trigger("chosen:updated");
    }

    function updateChosen(result, selector) {
        result.forEach(function (opt) {
            $(selector).append(new Option(opt, opt));
        });

        $(selector).trigger("chosen:updated");
    }
</script>
