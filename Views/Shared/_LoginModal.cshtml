<style>
    #loginModal .form-control:focus, #loginModal .btn:focus {
        box-shadow: 0 0 0 .25rem rgba(13,110,253,.15);
    }
</style>

<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">

            <div class="modal-header">
                <div class="rounded-5 d-inline-flex align-items-center justify-content-center bg-primary-subtle text-primary p-3" style="width:22px;height:22px;">
                    <i class="bi bi-shield-lock fs-5"></i>
                </div>
                <h5 class="modal-title fw-semibold mx-2" id="loginModalLabel">
                    Admin Login
                </h5>
                <button type="button" class="btn btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="loginForm" autocomplete="off">
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label fw-semibold">Password</label>

                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-key"></i>
                            </span>

                            <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Enter password" required />
                            <button type="button" class="btn btn-outline-secondary" id="toggleLoginPassword" title="Show/Hide">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>

                        <div id="loginError" class="text-danger text-shadow-small mt-2 d-none text-center mx-auto" style="max-width: 320px;">
                            Invalid password.
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="btnLogin">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Log in
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<script>
    function loginModal() {
        var el = $("#loginModal")[0];
        return bootstrap.Modal.getOrCreateInstance(el, { backdrop: true, keyboard: true });
    }

    $(document).on("click", "[data-login-modal='true']", function (e) {
        e.preventDefault();
        loginModal().show();
    });

    $(document).on("shown.bs.modal", "#loginModal", function () {
        $("#loginError").addClass("d-none");
        $("#loginPassword").trigger("focus");
    });

    $(document).on("hidden.bs.modal", "#loginModal", function () {
        var form = $("#loginForm")[0];
        if (form) form.reset();

        $("#loginError").addClass("d-none");
        $("#loginPassword").attr("type", "password");
        $("#toggleLoginPassword i").attr("class", "bi bi-eye");
    });

    $(document).on("click", "#toggleLoginPassword", function () {
        var $pwd = $("#loginPassword");
        var isHidden = ($pwd.attr("type") === "password");

        $pwd.attr("type", isHidden ? "text" : "password");
        $("#toggleLoginPassword i").attr("class", isHidden ? "bi bi-eye-slash" : "bi bi-eye");
    });

    $(document).on("submit", "#loginForm", function (e) {
        e.preventDefault(); // ✅ must be () !
        var password = $.trim($("#loginPassword").val() || "");

        $("#loginError").addClass("d-none").text("");

        if (!password) {
            $("#loginPassword").trigger("focus");
            return;
        }

        var $btn = $("#btnLogin").prop("disabled", true);

        $.post(`${root}Home/Login`, { password: password })
            .done(function (res) {
                if (res && res.ok) {
                    $("#MajordomeLink").removeClass("d-none");
                    const role = (res.role || res.Role || "");

                    setMajordomeMenu(role);

                    loginModal().hide();
                    return;
                }

                $("#loginError").removeClass("d-none").text(res?.msg || "Invalid password.");
                $("#loginPassword").trigger("focus").select();
            })
            .fail(function () {
                console.error("Error setting admin:");
                $("#loginError").removeClass("d-none").text("Server error. Try again.");
            })
            .always(function () {
                $btn.prop("disabled", false);
            }
        );
    });

    function loginModal() {
        return bootstrap.Modal.getOrCreateInstance($("#loginModal")[0], { backdrop: true, keyboard: true });
    }


</script>