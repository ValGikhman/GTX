@model GTX.Models.HealthModel
@{
    ViewBag.Title = "Health";
    Layout = null; // or your layout
}

<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Health</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        .metric {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .subtle {
            font-size: .875rem;
            color: var(--bs-secondary-color);
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
            <div>
                <h3 class="mb-0">Health</h3>
                <div class="subtle">
                    Server time:
                    <span class="mono">@Model.ServerTime.ToString("yyyy-MM-dd HH:mm:ss zzz")</span>
                </div>
            </div>

            <div class="d-flex gap-2">
                <a class="btn btn-outline-primary btn-sm" href="@Url.Action("Index","Health")">Refresh</a>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Process</div>
                        <div class="metric">@Model.ProcessName <span class="fs-6 text-secondary">(PID @Model.Pid)</span></div>
                        <div class="subtle mt-2">Current IIS worker process hosting this app</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Working Set (physical)</div>
                        <div class="metric">@FmtBytes(Model.WorkingSetBytes)</div>
                        <div class="subtle mt-2">w3wp “in use” physical memory</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Private Bytes</div>
                        <div class="metric">@FmtBytes(Model.PrivateBytes)</div>
                        <div class="subtle mt-2">Private memory owned by the process</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Paged Bytes</div>
                        <div class="metric">@FmtBytes(Model.PagedBytes)</div>
                        <div class="subtle mt-2">Paged memory used by the process</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">.NET Managed Heap</div>
                        <div class="metric">@FmtBytes(Model.ManagedBytes)</div>
                        <div class="subtle mt-2">GC.GetTotalMemory(false)</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Machine Available Memory</div>
                        <div class="metric">@FmtBytes(Model.AvailableBytes)</div>
                        <div class="subtle mt-2">May be null if perf counters are blocked</div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="subtle">Machine Committed Bytes</div>
                        <div class="metric">@FmtBytes(Model.CommittedBytes)</div>
                        <div class="subtle mt-2">Committed virtual memory (not “total RAM”)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-secondary mt-3 mb-0">
            <div class="subtle mb-1">Notes</div>
            <ul class="mb-0">
                <li><span class="mono">Committed Bytes</span> is not total physical RAM; it’s committed virtual memory.</li>
                <li>If counters return null, run the app pool with sufficient permissions or enable perf counters.</li>
            </ul>
        </div>
    </div>
</body>
</html>

@functions {
    public static string FmtBytes(long? bytes)
    {
        if (bytes == null) return "—";
        double n = bytes.Value;
        string[] u = { "B", "KB", "MB", "GB", "TB" };
        int i = 0;
        while (n >= 1024 && i < u.Length - 1) { n /= 1024; i++; }
        return i == 0 ? $"{n:0} {u[i]}" : $"{n:0.00} {u[i]}";
    }
}
