@{
    ViewBag.Title = "Health";
}

<style>
    body {
        background: #f6f7fb;
    }

    .wrap {
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
    }

    .card-elev {
        border: 0;
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .kpi-label {
        font-size: .8rem;
        color: rgba(33,37,41,.65);
        letter-spacing: .02em;
    }

    .kpi-value {
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        line-height: 1.1;
    }

    .kpi-sub {
        font-size: .85rem;
        color: rgba(33,37,41,.65);
    }

    .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .pill {
        border-radius: 999px;
    }

    .progress {
        height: 10px;
        border-radius: 999px;
        background: rgba(0,0,0,.06);
    }

    .progress-bar {
        border-radius: 999px;
    }

    .table thead th {
        font-size: .8rem;
        color: rgba(33,37,41,.65);
        font-weight: 700;
        border-bottom: 1px solid rgba(0,0,0,.06);
        white-space: nowrap;
    }

    .table td {
        padding-top: 14px;
        padding-bottom: 14px;
    }

    .cell-metric {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
    }

        .cell-metric .val {
            font-weight: 800;
            letter-spacing: -0.01em;
        }

        .cell-metric .unit {
            font-size: .8rem;
            color: rgba(33,37,41,.6);
        }

    /* Optional: slightly tighter padding on very small screens */
    @@media (max-width: 575.98px) {
        .health-card {
            padding: 1.25rem !important;
        }
        /* ~p-4 */
        .kpi-value {
            font-size: 1.75rem;
        }
    }

    /* Bigger Bootstrap switch */
    .big-switch.form-check-input {
        width: 3.4rem;
        height: 1.8rem;
        margin-top: 0;
        cursor: pointer;
    }

        /* Improve thumb size/position for the bigger switch */
        .big-switch.form-check-input:checked {
            background-position: right center;
        }

    /* Optional: slightly bigger label next to it */
    .form-check-label {
        cursor: pointer;
    }
</style>

<div class="container py-4 wrap">

    <!-- Header -->
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
        <div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <h2 class="mb-0" style="font-weight:850; letter-spacing:-.03em;">Health</h2>
                <span id="statusBadge" class="badge text-bg-secondary pill">Idle</span>
            </div>
            <div class="text-secondary small">
                Updated: <span class="mono" id="updated">—</span>
            </div>
        </div>
    </div>

    <!-- ROW: Cards -->
    <div class="row g-3">

        <!-- IIS Card -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="h-100 shadow well rounded-5 p-5 health-card">
                <div class="kpi-label">IIS</div>

                <div class="mt-3">
                    <div class="d-flex align-items-end justify-content-between">
                        <div class="kpi-value" id="iisCpu">—</div>
                        <div class="kpi-sub">CPU</div>
                    </div>
                    <div class="progress mt-2">
                        <div id="iisCpuBar" class="progress-bar" style="width:0%"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="d-flex align-items-end justify-content-between">
                        <div class="kpi-value" id="iisMem">—</div>
                        <div class="kpi-sub">Memory</div>
                    </div>
                    <div class="progress mt-2">
                        <div id="iisMemBar" class="progress-bar" style="width:0%"></div>
                    </div>
                </div>

                <div class="kpi-sub mt-4">
                    PID: <span class="mono" id="iisPid">—</span><br />
                    Working Set: <span class="mono" id="iisWs">—</span>
                </div>
            </div>
        </div>

        <!-- Total CPU Card -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="h-100 shadow well rounded-5 p-5 health-card">
                <div class="kpi-label">Total CPU</div>
                <div class="d-flex align-items-end justify-content-between mt-1 flex-wrap gap-2">
                    <div class="kpi-value" id="totCpu">—</div>
                    <div class="kpi-sub" id="statusText">Polling every 2 seconds</div>
                </div>
                <div class="progress mt-2">
                    <div id="totCpuBar" class="progress-bar" style="width:0%"></div>
                </div>
                <div class="kpi-sub mt-2">System-wide usage</div>
            </div>
        </div>

        <!-- Total Memory Card -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="h-100 shadow well rounded-5 p-5 health-card">
                <div class="kpi-label">Total Memory Used</div>
                <div class="d-flex align-items-end justify-content-between mt-1 flex-wrap gap-2">
                    <div class="kpi-value" id="totMem">—</div>
                    <div class="kpi-sub mono" id="updated2">—</div>
                </div>
                <div class="progress mt-2">
                    <div id="totMemBar" class="progress-bar" style="width:0%"></div>
                </div>
                <div class="kpi-sub mt-2" id="totRam">—</div>
                <div class="kpi-sub mt-1" id="totMemLoad" style="display:none;"></div>
            </div>
        </div>

        <!-- Active Sessions Card -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="h-100 shadow well rounded-5 p-5 health-card">
                <div class="kpi-label">Active Sessions</div>

                <div class="d-flex align-items-end justify-content-between mt-1">
                    <div class="kpi-value" id="activeSessions">—</div>
                </div>

                <div class="kpi-sub mt-2">
                    Session-based (IIS app pool)
                </div>
            </div>
        </div>

        <!-- Offline / Maintenance Mode Card -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="h-100 shadow well rounded-5 p-5 health-card">
                <div class="d-flex align-items-center justify-content-between gap-3">
                    <div class="kpi-label mb-0">Maintenance</div>

                    <!-- Bigger switch (top row) -->
                    <div class="form-check form-switch m-0 d-flex align-items-center gap-2">
                        <input class="form-check-input big-switch" type="checkbox" id="chkOffline" role="switch">
                        <label class="form-check-label kpi-sub user-select-none mb-0" for="chkOffline">
                            Enable
                        </label>
                    </div>
                </div>

                <!-- Body -->
                <div class="d-flex align-items-start gap-3 mt-4">
                    <div class="rounded-4 d-flex align-items-center justify-content-center border bg-light flex-shrink-0"
                         style="width:48px;height:48px;">
                        <i class="bi bi-shield-exclamation fs-4 text-danger"></i>
                    </div>

                    <div>
                        <div class="kpi-value">Offline</div>
                        <div class="kpi-sub mt-2">
                            When enabled, visitors are redirected to the out-of-service page.
                        </div>
                        <div class="kpi-sub mt-3" id="offlineStatusText">Online</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const url = '@Url.Action("HealthJson", "Health")';

    function bytesToMb2(bytes) {
        if (bytes === null || bytes === undefined || isNaN(bytes)) return "—";
        return (Number(bytes) / (1024 * 1024)).toFixed(2) + " MB";
    }

    function pctMb(pctVal, bytesVal) {
        if (pctVal === null || pctVal === undefined || isNaN(pctVal)) return "—";
        return Number(pctVal).toFixed(1) + "%";
    }

    function fmtBytes(b) {
        if (b === null || b === undefined) return "—";
        const u = ["B", "KB", "MB", "GB", "TB"];
        let i = 0, n = Number(b);
        while (n >= 1024 && i < u.length - 1) { n /= 1024; i++; }
        return (i === 0 ? n.toFixed(0) : n.toFixed(2)) + " " + u[i];
    }

    function fmtPct(v) {
        if (v === null || v === undefined || isNaN(v)) return "—";
        return Number(v).toFixed(1);
    }

    function clampPct(v) {
        v = Number(v);
        if (isNaN(v)) return 0;
        if (v < 0) return 0;
        if (v > 100) return 100;
        return v;
    }

    function setBar(id, pct) {
        $("#" + id).css("width", clampPct(pct).toFixed(1) + "%");
    }

    function setStatus(state, text) {
        const $badge = $("#statusBadge");
        const $statusText = $("#statusText");

        $badge.removeClass("text-bg-secondary text-bg-success text-bg-warning text-bg-danger");

        if (state === "ok") { $badge.addClass("text-bg-success").text("OK"); }
        else if (state === "loading") { $badge.addClass("text-bg-warning").text("Loading"); }
        else if (state === "error") { $badge.addClass("text-bg-danger").text("Error"); }
        else { $badge.addClass("text-bg-secondary").text("Idle"); }

        $statusText.text(text || "");
    }

    function safeGet(obj, path, fallback) {
        try { return path.split(".").reduce((o, k) => o && o[k], obj) ?? fallback; }
        catch { return fallback; }
    }

    function parseNetDate(v) {
        if (!v) return null;
        const iso = new Date(v);
        if (!isNaN(iso)) return iso;
        const m = /\/Date\((\d+)(?:[+-]\d+)?\)\//.exec(v);
        if (m) return new Date(parseInt(m[1], 10));
        return null;
    }

    function refreshNow() {
        setStatus("loading", "Refreshing…");

        $.ajax({
            url: url,
            method: "GET",
            cache: false,
            dataType: "json",
            success: function (data) {
                const totCpu = safeGet(data, "Totals.CpuPercentTotal", 0);
                const totMem = safeGet(data, "Totals.MemoryPercentTotal", 0);
                const totalPhys = safeGet(data, "Totals.TotalPhysBytes", null);
                const availPhys = safeGet(data, "Totals.AvailPhysBytes", null);

                $("#totCpu").text(fmtPct(totCpu) + "%");
                $("#totMem").text(fmtPct(totMem) + "%");
                setBar("totCpuBar", totCpu);
                setBar("totMemBar", totMem);

                $("#totRam").text(`${fmtBytes(totalPhys)} total / ${fmtBytes(availPhys)} free`);

                const memLoad = safeGet(data, "Totals.MemoryLoadPercent", null);
                if (memLoad !== null && memLoad !== undefined) $("#totMemLoad").show().text(`Windows MemoryLoad: ${memLoad}%`);
                else $("#totMemLoad").hide();

                const stRaw = safeGet(data, "ServerTime", null);
                const st = parseNetDate(stRaw);
                const timeText = st ? st.toLocaleTimeString() : "—";
                $("#updated").text(timeText);
                $("#updated2").text(timeText);

                const iis = safeGet(data, "IIS", null);
                const iisWs = safeGet(iis, "WorkingSetBytes", null);
                const iisPriv = safeGet(iis, "PrivateBytes", null);

                $("#iisPid").text(safeGet(iis, "Pid", "—"));
                $("#iisCpu").text(pctMb(safeGet(iis, "CpuPercent", null), iisWs));
                $("#iisMem").text(pctMb(safeGet(iis, "MemoryPercent", null), iisPriv));
                $("#iisWs").text(fmtBytes(safeGet(iis, "WorkingSetBytes", null)));
                setBar("iisCpuBar", safeGet(iis, "CpuPercent", 0));
                setBar("iisMemBar", safeGet(iis, "MemoryPercent", 0));

                const act = safeGet(data, "ActiveSessions", null);
                $("#activeSessions").text(act === null ? "—" : act);

                setStatus("ok", "Live");
            },
            error: function (xhr) {
                setStatus("error", "HTTP " + (xhr && xhr.status ? xhr.status : "error"));
            }
        });
    }

    $(function () {
        function setUi(isOffline) {
            $("#chkOffline").prop("checked", isOffline);
            $("#offlineStatusText").text(isOffline ? "Offline (redirecting users)" : "Online");
        }

        // Load current state
        $.get("/Health/GetOffline", function (r) {
            setUi(!!r.isOffline);
        });

        // Toggle
        $("#chkOffline").on("change", function () {
            const on = this.checked;
            setUi(on); // instant UI feedback

            $.post("/Health/SetOffline", { isOffline: on })
                .fail(function (xhr) {
                    // If server rejects, revert UI
                    setUi(!on);
                    alert("Failed to update maintenance mode.\n" + xhr.status + " " + xhr.statusText);
                });
        });

        refreshNow();
        setInterval(refreshNow, 2000);
    });
</script>
